name: Release Workflow

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release Type'
        required: true
        default: 'nightly'
        type: choice
        options:
          - nightly
          - beta
          - stable

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version.outputs.VERSION }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # --- Versioning ---
      - name: Calculate & Update Version
        id: version
        run: |
          chmod +x scripts/version_manager.py
          python3 scripts/version_manager.py --type ${{ inputs.release_type }}

      - name: Commit Version Bump
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add VERSION
          git commit -m "chore: bump version to ${{ steps.version.outputs.VERSION }}"
          git push

      # --- GitHub Release ---
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Release v${{ steps.version.outputs.VERSION }}
          generate_release_notes: true
          prerelease: ${{ inputs.release_type != 'stable' }}

      # --- Docker Publishing (Optional) ---
      # Only runs if secrets are present
      - name: Check Docker Credentials
        id: check_creds
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          if [[ -n "$DOCKER_USERNAME" ]]; then
            echo "has_creds=true" >> $GITHUB_OUTPUT
          else
            echo "has_creds=false" >> $GITHUB_OUTPUT
          fi

      - name: Login to Docker Hub
        if: steps.check_creds.outputs.has_creds == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set Docker Tags
        id: tags
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          TAGS=""
          
          # Docker Hub (Only if credentials exist)
          if [ "${{ steps.check_creds.outputs.has_creds }}" == "true" ]; then
            DH_IMAGE=${{ secrets.DOCKER_USERNAME }}/er-aimusicpage
            TAGS="${DH_IMAGE}:${VERSION}"
            if [ "${{ inputs.release_type }}" == "stable" ]; then
              TAGS="${TAGS},${DH_IMAGE}:latest"
            fi
          fi
          
          # GHCR (Always, force lowercase)
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          GH_IMAGE=ghcr.io/$OWNER/er-aimusicpage
          
          # Append comma if TAGS is not empty
          if [ -n "$TAGS" ]; then
            TAGS="${TAGS},"
          fi
          
          TAGS="${TAGS}${GH_IMAGE}:${VERSION}"
          if [ "${{ inputs.release_type }}" == "stable" ]; then
            TAGS="${TAGS},${GH_IMAGE}:latest"
          fi
          
          echo "docker_tags=$TAGS" >> $GITHUB_OUTPUT

      - name: Build and Push Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.tags.outputs.docker_tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
